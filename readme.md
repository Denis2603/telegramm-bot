Телеграмм бот по поиску отелей
==============================

Основные функции
----------------

* Поиск отелей в заданном городе
* Вывод самих дорогих, дешевых отелей, либо находящихся ближе к центру
* Настройка параметров вывода
  * количества отелей
  * выводить или нет фотографии
* Сохранение истории поиска
* Расчет стоимости проживания по указанным датам

**_Источник информации для бота - API сайта [Hotels.com](https://www.hotels.com/)_**

Инструкция по установке и первому запуску 
-----------------------------------------

1. Скопировать файлы проекта
```commandline
git clone https://github.com/Denis2603/telegramm-bot
```
Эта команда создаст папку `telegramm-bot`  и сохранит в ней все требуемые файлы.

2. Установить зависимости:
```commandline
pip install -r requirements.txt
```
*Рекомендуется настроить [виртуальное окружение](https://docs.python.org/3/library/venv.html).*

3. Получить ключ для работы с API
   1. Зарегистрироваться на сайте [rapidapi.com](https://rapidapi.com)
   2. Оформить подписку на [API Hotels](https://rapidapi.com/apidojo/api/hotels4/)
   3. Оформить подписку на [Forward & Reverse Geocoding](https://rapidapi.com/GeocodeSupport/api/forward-reverse-geocoding) с того же аккаунта

4. Создать нового бота и получить токен для работы с ним.  
    1. В приложении telegramm нужно бота [BotFather](https://t.me/botfather)
    2. Создать нового бота командой `/newbot`
    3. Выполнить несколько простых шагов  
[Руководство](https://core.telegram.org/bots#6-botfather) 

5. Переименовать файл `.env.template` в `.env`, указать в нем свой токен для бота и ключ от Rapid API  
Пример файла `.env`:
```dotenv
BOT_TOKEN='5129698927:AAGDrtF8BhpsZkfJkz8d8V8sd80--------'
RAPID_API_KEY='e16bf7299amsh132539e6181c99dp1996efjsnf55b--------'
```

6. Запустить программу
```commandline
python main.py
```

Работа с телеграмм ботом
------------------------
### Начало работы
Для начала работы отправьте боту команду `/start`

### Поиск отелей
На первом шаге можно **Выбрать город**, **Указать даты** проживания, посмотреть **Историю** своих запросов.  
Для перехода к следующему шагу нажать кнопку **Далее**

![Изображение экрана](/materials/foto/1.jpg "Шаг 1")
![Изображение экрана](/materials/foto/2.jpg "Шаг 2")  

На втором шаге можно выбрать тип отелей для получения: **Недорогие**, **Дорогие**, **Ближе к центру**.  
Для изменения города или дат проживания нажать **Назад**  
Нажатием на кнопку **Кол-во отелей** можно последовательно изменить количество выводимых отелей *5->10->...->30->5*  
Кнопка **Фото** переключает режим вывода фотографий *Да/Нет*

### Пример ответа телеграм бота.  
**Город:** Париж  
**Отели** дорогие

![Изображение экрана](/materials/foto/3.jpg "Ответ без фото")
![Изображение экрана](/materials/foto/4.jpg "Ответ с фото")

Настройки бота
--------------

В файле `config_data/config.py` находятся настройки, регулирующие поведение бота.

```dotenv
NUMBER_OF_FOTO = 7  # количество выводимых фото по умолчанию
DES_TO_FILE = True  # запись запроса уточнения локации в файл
HOTELS_TO_FILE = False  # запись запроса отелей в файл
FOTO_TO_FILE = True  # запись запросов фото в файл
RESPONSE_FROM_FILE = True  # попытка считать ответ из файла, если подходящий есть в базе (только для FOTO и DES)
HISTORY = 5  # Количество запросов выводимых в истории
```

С помощью переменных `***_TO_FILE` можно сохранять ответы от API в файлы. Ответ сохраняется в формате JSON в папку `materials/api_request/`  
Если `RESPONSE_FROM_FILE = True` то ответ пользователю будет считан из файла, что позволяет несколько ускорить работу и сократить количество запросов к API.

Разработчикам
-------------

История поиска реализована в виде базы данных SQLite.
Если база не существует, то она создается при первом запуске бота.

Нигде в боте не происходит непосредственного обращения к базе данных. Все взаимодействие происходит с помощью команд, 
реализованных в модуле `database.command`  
Таким образом, создана небольшая ORM для работы с БД и при переходе на другую базу данных, например MySQL потребуется 
переписать только эти команды, не затрагивая основной функционал бота.  
Пример команды:
```python
# database/command.py
def get_last(user_id: int) -> list:
    """
    Возвращает из базы последний запрос пользователя
    :param user_id: ID пользователя
    :return: Кортеж с данными запроса
    """
    with history:
        return history.execute("SELECT date, city AS city_id, (SELECT name FROM city WHERE id=request.city) AS city, "
                               "checkin, checkout, sort FROM request WHERE user=(?) ORDER BY date DESC LIMIT 1",
                               (user_id,)).fetchall()
```
